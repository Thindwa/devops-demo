name: Main promotion guard

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, synchronize, ready_for_review]
  # If you use GitHub merge queue, enforce the same rule there too.
  merge_group:
    branches:
      - main

jobs:
  allow_only_staging_to_main:
    name: Allow only staging â†’ main
    runs-on: ubuntu-latest
    steps:
      - name: Block non-staging PRs into main
        shell: bash
        run: |
          # For pull_request events, GitHub provides the source branch as GITHUB_HEAD_REF.
          # For merge_group, it may be empty; in that case we allow the queue to proceed.
          head="${GITHUB_HEAD_REF:-}"

          if [ -z "$head" ]; then
            echo "No head ref available (merge_group). Skipping strict check."
            exit 0
          fi

          if [ "$head" != "staging" ]; then
            echo "::error::This repository only allows production promotion via a PR from 'staging' into 'main'."
            echo "::error::Current PR source branch: '$head'"
            exit 1
          fi

          echo "OK: PR source branch is 'staging'."

